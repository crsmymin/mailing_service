<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="member">
	<select id="getGroupList" parameterType="String" resultType="GroupVO">
               <![CDATA[
                       SELECT group_id,
						    group_name,
						    req_date,
						    delete_date,
						    (select count(*) from mail_member as m where g.group_id = m.group_id and m.delete_date is null) AS member_cnt
						FROM reverse_mail.mail_group g
						WHERE delete_date IS NULL
						ORDER BY group_name
               ]]>
     </select>
	 
	 <insert id="insertGroup" parameterType="java.util.List">
	    INSERT INTO mail_group (group_name) VALUES
	    <foreach collection="list" item="item" separator=" , " >
	        (#{item.group_name})
	    </foreach>
	</insert>
	
	 <update id="updateGroup" parameterType="java.util.List" >
	  <foreach collection="list" item="item" separator=" ; " >
	 	 update reverse_mail.mail_group set
		    group_name = #{item.group_name}
		  where group_id = #{item.group_id}
	   </foreach>
	</update>
	
	 <update id="deleteGroup" parameterType="String" >
	  update reverse_mail.mail_group set
		     delete_date = now()
		  where group_id in (${value})
	</update>
     
     <select id="getMemberList" parameterType="java.util.HashMap" resultType="MemberVO">
           SELECT member_id,
		    group_id,
		    (select group_name from mail_group as g where g.group_id = m.group_id) AS group_name,
		    member_name,
		    member_mail,
		    req_date,
		    delete_date,
		    rejection_date
		FROM reverse_mail.mail_member m
		WHERE delete_date IS NULL
		<if test='value != null'>
			AND (member_name like CONCAT('%',#{value},'%') OR member_mail like CONCAT('%',#{value},'%'))
		</if>
		<if test="id != null and !id.equals('')" >
			AND group_id=#{id}
		</if>
		ORDER BY member_name
     </select>
     
     
	 <insert id="insertMember" parameterType="java.util.List">
	    INSERT INTO mail_member (member_name,member_mail,group_id) VALUES
	    <foreach collection="list" item="item" separator=" , " >
	        (#{item.member_name},#{item.member_mail},#{item.group_id})
	    </foreach>
	</insert>
	
     <update id="updateMember" parameterType="java.util.List" >
	  <foreach collection="list" item="item" separator=" ; " >
	 	 update reverse_mail.mail_member set
		    <if test='item.member_name != null'>
				 member_name = #{item.member_name}
			</if>
			<if test='item.member_mail != null'>
				 member_mail = #{item.member_mail}
			</if>
		  where member_id = #{item.member_id}
	   </foreach>
	</update>
	
	<update id="deleteMember" parameterType="String" >
	  update reverse_mail.mail_member set
		     delete_date = now()
		  where member_id in (${value})
	</update>
</mapper>
